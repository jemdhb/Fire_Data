---
title: "Fire Data"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

## Load Packages 
```{r}
library("RSQLite")
library("tidyr")
library("rspatial")
library("dbplyr")
library("dplyr")
library("rworldmap")
library("readxl")
library("purrr")
library("ggplot2")
library("maps")
library("mapdata")
library("usmap")
require("devtools")
library("ggpubr")
library("rnaturalearth")
library("rnaturalearthdata")
#library("rgdal")

```
## Acess US Fire data with SQL
data source: 
```{r}
#maps we will use in our analysis
#hawaii map
hawaii <- subset(getData("GADM", country = "usa", level = 1), NAME_1 == "Hawaii")
#hawaii <- subset(usa, NAME_1 == "Hawaii")

#will be re positioned alaska map
us_ak<- subset(ne_countries(scale='medium',returnclass = 'sf'), admin == "United States of America")

```


```{r}
fires <- DBI::dbConnect(RSQLite::SQLite(), "FPA_FOD_20170508.sqlite")
src_dbi(fires)
```


```{r}
dbListFields(fires, "fires")
#DISCOVERY_DATE -CONT_DATE see average fire length 
#Fire_size is in acres
#FIPS_CODE do county density ?

```

## Pare down fire data to what will be used in our analysis
```{r}
fire_info<-tbl(fires, sql("SELECT OBJECTID, SOURCE_SYSTEM, SOURCE_REPORTING_UNIT_NAME, FIRE_NAME, FIRE_YEAR,DISCOVERY_DATE, STAT_CAUSE_DESCR, CONT_DATE,FIRE_SIZE, FIRE_SIZE_CLASS,LATITUDE, LONGITUDE,STATE,COUNTY, FIPS_CODE, FIPS_NAME, COUNTY, FIPS_NAME FROM fires"))
#head(fire_info, n = 10)
causes<-data.frame(fire_info %>%
    select(STAT_CAUSE_DESCR,LATITUDE,LONGITUDE,STATE,FIRE_SIZE,FIRE_SIZE_CLASS))
head(causes)

fire_info=NA
```
Lets examine the most common causes for fires
```{r}
# Show the causes of fire with counts in descending order
ggplot(dbGetQuery(fires, "
           SELECT 
           STAT_CAUSE_DESCR, 
           count(*) as [count] 
           FROM Fires 
           GROUP BY STAT_CAUSE_DESCR 
           ORDER BY count DESC;"),aes(y=count,x=reorder(STAT_CAUSE_DESCR,count)))+geom_bar(stat="identity",fill="brown4", color="darkred")+coord_flip()+xlab("Cause of fire")+ylab("Count")+ggtitle("Causes of all fires (by count)")+theme_minimal()
```
## Define graphical functions
```{r}
kernel_density_map<-function(df,map,title,xlim=FALSE){
  #load map data
  #us<-map_data("state")
  us<-map
  if(xlim==TRUE){
     base_plot<-ggplot(causes, aes(x = LONGITUDE, y = LATITUDE))+theme_void()+xlim(-178,-154)
  }
  else{
   base_plot<-ggplot(causes, aes(x = LONGITUDE, y = LATITUDE))+theme_void()+xlim(-125,-65)+ylim(20,50)
  }
  #create density map based on position on point
  
  
  #overlay the US map and add labels
  base_plot<-base_plot+geom_polygon(data=us,aes(x=long,y=lat,group=group))+
  xlab('Longitude') + ylab('Latitude') 
  #fine tune presentation of density plot
  base_plot<-base_plot+stat_density2d(aes(fill = ..level..), alpha = .5,
                           geom = "polygon", data = df) + 
  scale_fill_viridis_c(alpha=0.3,begin=.55,option="plasma") +
  theme(legend.position = 'none')+ggtitle(title)
  
  return(base_plot)
}
#remove dual grouping (i think in geom polygon)?
scatter_map<-function(df,xx,yy,title){
  us<-map_data("state")
  #plot points that represent location of fire
  base_plot<-ggplot(df,aes_string(x=xx,y=yy))+
    geom_polygon(data=us,aes(x=long,y=lat,group=group),color='gray',fill=NA,alpha=.1)+
    geom_point(size=.05,alpha=.05,color="darkred")+xlim(-125,-65)+ylim(20,50)+
    ggtitle(title)+theme_minimal()+xlab("Longitude")+ylab("Latitude")
  
  #overlay map
 base_plot+xlim(-125,-65)+ylim(20,50)
}

bar_map<-function(df,cat,title){
ggplot(df, aes(x= reorder(cat,cat,function(x)+length(x)))) +
geom_bar(fill="brown4", color="darkred")+coord_flip()+ggtitle(title)
  
}
```
Lets simplify the causes listed above into three more palatable categories. 
Natural fires (N) are those caused by lightning. Unknown fires (UK) are the 
miscellaneous fires or the missing/undefined fires. Man-made fires (M) are all 
of the other fire categories in our dataset.
```{r}
#sql query that separates our STAT_CAUSE_DESCR data into the three groups 
# outlined above. This column is names CAUSE_GROUP and is what our df is grouped
# on. We then sum the count of each of these categories with the
# column count and the acres burned by each category with total_areas
fires_by_cause<-dbGetQuery(fires, "
           SELECT 
           CASE 
           WHEN STAT_CAUSE_DESCR == 'Lightning' THEN 'N'
           WHEN TRIM(STAT_CAUSE_DESCR) == 'Miscellaneous' OR
           STAT_CAUSE_DESCR == 'Missing/Undefined' THEN 'UK'
           ELSE 'M'
           END as 'CAUSE_GROUP',
           count(*) as [count],
           ROUND(SUM(FIRE_SIZE), 0) as total_area
           FROM Fires
           GROUP BY CAUSE_GROUP
           ")
#peek at results
fires_by_cause
```
Now with one SQL call the differences between these categories both in raw 
counts and the area burned is clear. Lets represent these differences in a 
count plot

```{r}
ggplot(fires_by_cause,aes(y=count,x=reorder(CAUSE_GROUP,count)))+
  geom_bar(stat="identity",fill="brown4",color="darkred")+
  theme_minimal()+scale_x_discrete(labels=c("Natural", "Unknown", 
  "Man Made"))+labs(x="Cause Type",y="Counts",title=
                      "Count of all fires by cause")
```

Man made fires are by far the most common. Man-made fires are 3x more common 
than natural fires and more than 2x as common as unknown fires. Now lets examine 
the area burned by each category of fire.
```{r}
ggplot(fires_by_cause,aes(y=total_area,x=reorder(CAUSE_GROUP,total_area)))+
  geom_bar(stat="identity",fill="brown4", color="darkred")+
  theme_minimal()+scale_x_discrete(labels=
  c("Unknown", "Man Made","Natural"))+labs(x="Cause of fire",y="Total area burned (acres)",title="Total area burned by all fires (separated by cause)")

```
Now we see that even though the natural fires have the lowest count they have
caused the most damage in area burned. Perhaps this is because these natural 
fires tend to be further from population centers so they take longer to be
noticed?
```{r}
scatter_map(dbGetQuery(fires, "
SELECT 
LATITUDE,
LONGITUDE
FROM fires"),"LONGITUDE","LATITUDE","Scatterplot of all fires")
```
With so many fires in our dataset this essentially becomes a population density 
map, with some areas being so dense most of the points completely overlap. 
Lets take the kernel density of all of our fires to see if this better 
elucidates the trends.


```{r}
kernel_density_map_akhi<-function(df,map,xlim=FALSE){
  base_plot<-ggplot(df, aes(x = LONGITUDE, y = LATITUDE))+theme_void()
  #+theme(axis.title.x = element_text())
  
  base_plot<-base_plot+geom_polygon(data=map,aes(x=long,y=lat,group=group),inherit.aes = FALSE)+
    xlab('Longitude') + ylab('Latitude') 
  
  base_plot<-base_plot+stat_density2d(aes(fill = ..level..), alpha = .5,geom = "polygon")+
  scale_fill_viridis_c(alpha=0.3,begin=.55,option="plasma",guide="none")
  
  if(xlim!=FALSE){
     base_plot+xlim(-178,-154)
  }
  return(base_plot)
}
```

Due to inconsistencies with the map of Alaska in the mapping package I have been 
utilizing for the lower 48 states and Hawaii, I have chosen to use a map from a
different package. This changes our kernel density code from the function 
kernel_density_map. Alaska still is using the same kernel density formula under 
the hood so there shouldn't be inconsistencies in our results.
```{r}
#alaska map
ak_poly<-ggplot(data=dbGetQuery(fires, "
           SELECT 
           LATITUDE, LONGITUDE
           FROM fires
           WHERE STATE in ('AK')
           "),aes(y=LATITUDE, x=LONGITUDE))+
  geom_sf(data=us_ak$geometry,inherit.aes = FALSE,color="black",fill="black")+
  stat_density2d(aes(fill = ..level..), alpha = .5,geom = "polygon")+
  scale_fill_viridis_c(alpha=0.3,begin=.55,option="plasma")+
  xlim(-180,-130)+ylim(51,71)+theme_void()+theme(legend.position = 'none')
```

Lets calculate our kernel density for hawaii and the lower 48 states, which are 
located in different maps.
```{r}
hi<-kernel_density_map(dbGetQuery(fires, "
           SELECT 
           FIRE_YEAR, LATITUDE, LONGITUDE, FIRE_SIZE
           FROM fires
           WHERE STATE in ('HI')
           "),hawaii, "", TRUE)

```


```{r}
#lower 48 map
l48<-kernel_density_map(causes,map_data("state"),"Kernel Density of all Fires",FALSE)
```

Now we will display all three of our maps with the patchwork library
```{r}
library(patchwork)
layout <- "
AAAAAAAAAAAAAAAAAAAA#BBBBBBBBC
"
(l48 | ak_poly / hi)+
  plot_layout(design = layout)
```

Now lets see if fires follow different trends based on their cause when looking 
at them on the map of the United States.
```{r}
comb_causes<-dbGetQuery(fires, "
           SELECT 
           CASE 
           WHEN STAT_CAUSE_DESCR == 'Lightning' THEN 'N'
           WHEN TRIM(STAT_CAUSE_DESCR) == 'Miscellaneous' OR
           STAT_CAUSE_DESCR == 'Missing/Undefined' THEN 'UK'
           ELSE 'M'
           END as 'CAUSE_GROUP',
           FIRE_SIZE,
           LATITUDE,
           LONGITUDE,
           STATE
           FROM Fires
           ")

#unkown is at c[[3]] but wont examine those
c<-split(comb_causes, comb_causes$CAUSE_GROUP)
man<-drop_na(c[[1]])
natural<-drop_na(c[[2]])
```
Now that we have separated out fires by cause, lets see what these density maps 
elucidate. We will first examine the fires with natural causes (i.e. lightning 
strikes that led to a subsequent fire).

```{r}
#nothing changes about our lower 48 call, except the dataframe we are passing in
natural_48<-kernel_density_map(natural,map_data("state"), "Kernel Density of natural fires")

```


```{r}
#for Hawaii and Alaska we will pull from this dataframe instead of making a SQL
#call for the data.
HI_natural<-natural[natural$STATE=="HI",]
AK_natural<-natural[natural$STATE=="AK",]

ak_poly_natural<-ggplot(AK_natural,aes(y=LATITUDE, x=LONGITUDE))+
  geom_sf(data=us_ak$geometry,inherit.aes = FALSE,color="black",fill="black")+
  stat_density2d(aes(fill = ..level..), alpha = .5,geom = "polygon")+
  scale_fill_viridis_c(alpha=0.3,begin=.55,option="plasma")+
  xlim(-170,-130)+ylim(51,71)+theme_void()+theme(legend.position = 'none')

hi_poly_natural<-kernel_density_map(HI_natural,hawaii, "",TRUE)
```


```{r}
(natural_48 | ak_poly_natural / hi_poly_natural)+
  plot_layout(design = layout)
```

Now we will examine the density maps of fires caused by humans.
```{r}
#lower 48 map
man_48<-kernel_density_map(man,map_data("state"),"Density of man-made fires")
```


```{r}
#hawaii and alaska maps
HI_man<-man[man$STATE=="HI",]
AK_man<-man[man$STATE=="AK",]

ak_poly_man<-ggplot(AK_man,aes(y=LATITUDE, x=LONGITUDE))+
  geom_sf(data=us_ak$geometry,inherit.aes = FALSE,color="black",fill="black")+
  stat_density2d(aes(fill = ..level..), alpha = .5,geom = "polygon")+
  scale_fill_viridis_c(alpha=0.3,begin=.55,option="plasma")+
  xlim(-170,-130)+ylim(51,71)+theme_void()+theme(legend.position = 'none')

hi_poly_man<-kernel_density_map(HI_man,hawaii, "",TRUE)
```


```{r}
#display with same layout as before 
(man_48 | ak_poly_man / hi_poly_man)+
  plot_layout(design = layout)
```
```{r}
state_causes<-dbGetQuery(fires, "
           SELECT 
           STATE AS state,
           ROUND(SUM(FIRE_SIZE), 0) as total_area
           FROM Fires
           Where STATE not in ('PR','DC')
           GROUP BY STATE
           ")

state_causes
```

```{r}
plot_usmap(data = state_causes,values="total_area",color="white") + 
  scale_fill_viridis_c(alpha=1,begin=.55, end=0.9,option="plasma",
                       name = "Sum of value Burned", label = scales::comma) + 
  labs(title = "Sum of all Acres Burned by State from 1995 to 2015") +
  theme(legend.position = "right")
```
At this scale acres burned is clearly connected to the size of the state with 
larger states having more total acres burned by fires. This makes sense because 
they have a larger burn potential then the smaller states.Lets see if this trend 
persists when we account for the area of the states.

```{r}
#get area of states from built in R data
data("state")
df<-data.frame("area_km2"=state.area)
#see which state has had the most burn relative to their size 
#(area burned/state size)
state_causes$burned_by_area<-state_causes$total_area/df$area_km2
plot_usmap(data = state_causes,values="burned_by_area",color="white")+
  scale_fill_viridis_c(alpha=1,begin=.55, end=0.9,option="plasma",
                       name = "Sum of acres Burned", label = scales::comma)+ 
  labs(title = "Sum of all Acres Burned by State from 1995 to 2015 (Controlled by Area)")+
  theme(legend.position = "right")
```
When accounting for the size of the state, most of the states perform the same.
The most obvious outlier is Alaska which lacks the population and in turn the 
resources (or need) to put out as many fires. Other larger states with 
lower population such as Idaho, Nevada, New Mexico and Nebraska follow this 
trend to a lesser degree.
```{r}
#year_burned$logburned=log(year_burned$total_area)
ggplot(data=year_burned<-dbGetQuery(fires, "
           SELECT 
           FIRE_YEAR as year,
           ROUND(SUM(FIRE_SIZE), 0) as total_area
           FROM Fires
           GROUP BY FIRE_YEAR
           "), aes(x=year, y=total_area, group=1)) +
  geom_area(alpha=0.7,fill="firebrick4")+
  geom_line(color="firebrick4")+
  geom_point(alpha=0.7,colour="firebrick4")+
  ylim(0,10250000)+theme_minimal()+xlab("Year")+ylab("Sum of Acres Burned")

```
Start of unfinished work:
Maybe add data about best and worst years? 
```{r}
year_2015<-dbGetQuery(fires, "
           SELECT 
           FIRE_YEAR, LATITUDE, LONGITUDE, FIRE_SIZE
           FROM fires
           WHERE FIRE_YEAR in (2015) AND STATE in ('CA')
           ")

year_2015
```
```{r}
us<-map_data("state")
NewStates <- filter(us,region ==  "california"|region=="nevada"|region=="arizona"|region=="oregon")
#fill is wrong T-T
#plot points that represent location of fire
bp<-ggplot(year_2015,aes(y=LATITUDE,x=LONGITUDE,fill=Fire_SIZE))+geom_polygon(data=NewStates,aes(x=long,y=lat,group=group),inherit.aes = FALSE)+
  stat_density2d(aes(fill = ..level..), alpha = .5,geom = "polygon")+
  scale_fill_viridis_c(alpha=0.3,begin=.55,option="plasma")
bp
```
