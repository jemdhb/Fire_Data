---
title: "Fire Data"
output: html_notebook
---


```{r}
library("RSQLite")
library(dbplyr)

```



con <- dbConnect(drv=RSQLite::SQLite(), dbname="FPA_FOD_20170508.sqlite")
## list all tables
tables <- dbListTables(con)

## exclude sqlite_sequence (contains table information)
tables <- tables[tables != "sqlite_sequence"]
print(src_dbi(tables))
## create a data.frame for each table
lDataFrames<- Map(tables, ~{
  dbGetQuery(conn=con, statement=paste("SELECT * FROM fires"))})


```{r}
#bruh wtf fix later
fires <- DBI::dbConnect(RSQLite::SQLite(), "FPA_FOD_20170508.sqlite")
src_dbi(fires)

```


```{r}
library("ggmap")
library("rworldmap")
library("rgdal")
library("readxl")
library("purrr")
library(ggplot2)
library("usmap")
library(maps)
library(mapdata)
library(usmap)
#all 
fire_info<-tbl(fires, sql("SELECT OBJECTID, SOURCE_SYSTEM, SOURCE_REPORTING_UNIT_NAME, FIRE_NAME, FIRE_YEAR,DISCOVERY_DATE, STAT_CAUSE_DESCR, CONT_DATE,FIRE_SIZE, FIRE_SIZE_CLASS,LATITUDE, LONGITUDE,STATE,COUNTY, FIPS_CODE, FIPS_NAME, COUNTY, FIPS_NAME FROM fires"))

#pared down

head(fire_info, n = 10)

```
```{r}
causes<-data.frame(fire_info %>%
    select(STAT_CAUSE_DESCR,LATITUDE,LONGITUDE,STATE,FIRE_SIZE,FIRE_SIZE_CLASS))
causes
```

```{r}
# Basic barplot
ggplot(causes, aes(x= reorder(STAT_CAUSE_DESCR,STAT_CAUSE_DESCR,function(x)+length(x)))) +
  geom_bar(fill="brown4", color="darkred")+coord_flip()+ggtitle("Causes of man-made fires (by count)")
```

```{r}
kernel_density_map<-function(df,x,y,title){
  #load map data
  us<-map_data("state")
  #create density map based on position on point
  base_plot<-ggplot(causes, aes(x = LONGITUDE, y = LATITUDE))
  #overlay the US map and add labels
  base_plot<-base_plot+geom_polygon(data=us,aes(x=long,y=lat,group=group))+
  xlab('Longitude') + 
  ylab('Latitude') 
  #fine tune presentation of density plot
  base_plot+stat_density2d(aes(fill = ..level..), alpha = .5,
                 geom = "polygon", data = df) + 
  scale_fill_viridis_c(alpha=0.3,begin=.55,option="plasma") +
  theme(legend.position = 'none')+
  xlim(-125,-65)+ylim(20,50)+ggtitle(title)
}

scatter_map<-function(df,xx,yy,title){
  us<-map_data("state")
  #plot points that represent location of fire
  base_plot<-ggplot(df,aes(xx,yy))+geom_point(size=.05,alpha=.1,color="darkred")+xlim(-125,-65)+ylim(20,50)+ggtitle(title)
  #overlay map
 base_plot+geom_polygon(data=us,aes(x=long,y=lat,group=group),color='black',fill=NA,alpha=.1)+xlim(-125,-65)+ylim(20,50)
}

bar_map<-function(df,cat,title){
ggplot(df, aes(x= reorder(cat,cat,function(x)+length(x)))) +
geom_bar(fill="brown4", color="darkred")+coord_flip()+ggtitle(title)
  
}
```
us<-map_data("state")
#all causes
ggplot(causes[1:1000,],aes(LONGITUDE,LATITUDE)) +
  geom_polygon(data=us,aes(x=long,y=lat,group=group),color='gray',fill=NA,alpha=.1)+
  geom_point(size=.05,alpha=.1) +
  xlim(-125,-65)+ylim(20,50)+ggtitle("Scatterplot of all fires")

```{r}

scatter_map(causes,causes$LONGITUDE,causes$LATITUDE,"Scatterplot of all fires")
```
#all causes
us<-map_data("state")
ggplot(causes, aes(x = LONGITUDE, y = LATITUDE)) +  geom_polygon(data=us,aes(x=long,y=lat,group=group))+
  xlab('Longitude') + 
  ylab('Latitude') + 
  stat_density2d(aes(fill = ..level..), alpha = .5,
                 geom = "polygon", data = causes[1:1000,]) + 
  scale_fill_viridis_c(alpha=0.3,begin=.55,option="plasma") +
  theme(legend.position = 'none')+
  xlim(-125,-65)+ylim(20,50)+ggtitle("Density of all fires")

```{r}
kernel_density_map(causes,"LONGITUDE","LATITUDE","Density of all fires")

```
#m=man made, n=natural
ggplot(comb_causes, aes(x= reorder(STAT_CAUSE_DESCR,STAT_CAUSE_DESCR,function(x)+length(x)))) +
geom_bar(color="blue",fill=rgb(0.1,0.4,0.5,0.7))+coord_flip()+ggtitle("Count of man-made vs. natural fires")

```{r}
#get fire causes 
comb_causes<-causes["STAT_CAUSE_DESCR"]
#categorize them
#man-made
cause_man<-c("Campfire","Equipment Use","Arson","Children","Railroad","Smoking","Powerline","Structure","Fireworks","Debris Burning")
#cause nature
cause_nature<-c("Lightning")
#cause unknown, remove
cause_uk<- c("Missing/Undefined","Miscellaneous")
#remove unknown
comb_causes<-rapply(comb_causes,function(x) ifelse(x %in% cause_uk,NA,x), how = "replace")
remove_missing(comb_causes)
#separated by two causes 
comb_causes<-rapply(comb_causes,function(x) ifelse(x %in% cause_man,"m","n"), how = "replace")

bar_map(comb_causes,comb_causes$STAT_CAUSE_DESCR,"Count of man-made vs. natural fires")
```


```{r}
causes["STAT_CAUSE_DESCR"]<-comb_causes
c<-split(causes, causes$STAT_CAUSE_DESCR)
man<-c[[1]]
natural<-c[[2]]
natural
```
us<-map_data("state")
#all causes
ggplot(natural[1:1000,],aes(LONGITUDE,LATITUDE)) +
  geom_polygon(data=us,aes(x=long,y=lat,group=group),color='gray',fill=NA,alpha=.1)+
  geom_point(size=.05,alpha=.1) +xlim(-125,-65)+ylim(20,50)+ggtitle("Scatterplot of natural fires")


```{r}
scatter_map(natural,natural$LONGITUDE,natural$LATITUDE,"Scatterplot of natural fires")
```


t1<-natural[1:90,]
ggplot(natural, aes(x = LONGITUDE, y = LATITUDE)) +   geom_polygon(data=us,aes(x=long,y=lat,group=group))+
  xlab('Longitude') + 
  ylab('Latitude') + 
  stat_density2d(aes(fill = ..level..), alpha = .5,
                 geom = "polygon", data = t1) + 
  scale_fill_viridis_c(alpha=0.3,begin=.55,option="plasma") + 
  theme(legend.position = 'none')+ggtitle("Density of natural fires")+xlim(-130,-60)+ylim(20,50)


```{r}
kernel_density_map(natural,"LONGITUDE","LATITUDE","Density of natural fires")

```
us<-map_data("state")
#all causes
ggplot(man[1:1000,],aes(LONGITUDE,LATITUDE)) +
  geom_polygon(data=us,aes(x=long,y=lat,group=group),color='gray',fill="white",alpha=.1)+
  geom_point(size=.05,alpha=.1) +
  xlim(-125,-65)+ylim(20,50)+ggtitle("Scatterplot of man-made fires")
```{r}

#fix
scatter_map(man,man$LONGITUDE,man$LATITUDE,"Scatterplot of natural fires")

```

us<-map_data("state")
ggplot(man, aes(x = LONGITUDE, y = LATITUDE)) +   geom_polygon(data=us,aes(x=long,y=lat,group=group))+
  xlab('Longitude') + 
  ylab('Latitude') + stat_density2d(aes(fill = ..level..), alpha = .5, geom = "polygon", data = man[1:1000,]) + 
scale_fill_viridis_c(alpha=0.3,begin=.55,option="plasma") + 
theme(legend.position = 'none')+ggtitle("Density of man-made fires")+xlim(-130,-60)+ylim(20,50)

```{r}
kernel_density_map(man,"LONGITUDE","LATITUDE","Density of man-made fires")

```

```{r}

state_burned<-aggregate(natural$FIRE_SIZE, by=list(Category=natural$STATE), FUN=sum)
colnames(state_burned)<-c("state","burned")

plot_usmap(data = state_burned,values="burned",color="white") + scale_fill_viridis_c(alpha=1,begin=.55,option="plasma", name = "Sum of ? Burned", label = scales::comma) + 
labs(title = "All Fires Burned by State from 1995 to 2015") +
theme(legend.position = "right")
#basically correlated with size, make another dividing by the area of the region
```


```{r}
data("state")
df<-data.frame(state=state.name,"area_km2"=state.area)
#drop dc and pr which is not in the R default
state_burned<-subset(state_burned, state!="DC" & state!="PR")
#divide by area
state_burned$burned_by_area<-state_burned$burned/state.area
plot_usmap(data = state_burned,values="burned_by_area",color="white") + scale_fill_viridis_c(alpha=1,begin=.55,option="plasma", name = "Sum of ? Burned", label = scales::comma) + 
labs(title = "All Fires Burned by State from 1995 to 2015 Controlled by Area") +theme(legend.position = "right")
#seems to be centralized (excluding alaska)
```


```{r}
#drop dc and pr which is not in the R default
state_burned<-subset(state_burned, state!="DC" & state!="PR")
state_burned$logburned=log(state_burned$burned)
#divide by area
state_burned$log_burned_by_area<-state_burned$logburned/log(state.area)
plot_usmap(data = state_burned,values="log_burned_by_area",color="white") + scale_fill_viridis_c(alpha=1,begin=.55,option="plasma", name = "Sum of ? Burned", label = scales::comma) + 
labs(title = "All log Fires Burned by State from 1995 to 2015 Controlled by Area") +theme(legend.position = "right")
#seems to be centralized (excluding alaska)
```


```{r}
d<-data.frame(state=state.name,"center"=state.center)
colnames(d)<-c("state","x","y")
state_burned$lat<-d$x
state_burned$long<-d$y
#make barplot ig since kernel density is so bad lol
#sort in order by size
ggplot(data=state_burned, aes(x=state, y=logburned)) +
  geom_bar(fill="firebrick4",stat='identity')+coord_flip()
```



```{r}
years<-data.frame(fire_info %>%
    select(FIRE_YEAR,FIRE_SIZE,LATITUDE, LONGITUDE))

year_burned<-aggregate(years$FIRE_SIZE, by=list(Category=years$FIRE_YEAR), FUN=sum)
colnames(year_burned)<-c("year","burned")#,"lat","long")
year_burned
```
```{r}
year_burned$logburned=log(year_burned$burned)
#reg1 <- lm(burned~year,data=year_burned) 
ggplot(data=year_burned, aes(x=year, y=burned, group=1)) +
  geom_line(alpha=0.7,linetype=4,colour="firebrick4")+
  geom_point(alpha=0.7,colour="firebrick4")+ylim(0,10250000)
```